<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="sudoli&#39;s blog">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->





<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->


<title>notminist数据预处理示范LogisticRegression训练 | sudoli&#39;s blog</title>


    <link rel="alternate" href="/atom.xml" title="sudoli&#39;s blog" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div><!-- hexo-inject:begin --><!-- hexo-inject:end -->






    

</head>


<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="main-header"  style="background-image:url(http://onq81n53u.bkt.clouddn.com/neweeess_%E5%89%AF%E6%9C%AC.png)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='sudoli'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> best </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://yoursite.com">sudoli&#39;s blog</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>主页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/机器学习/"><i class="fa "></i>机器学习</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/深度学习/"><i class="fa "></i>深度学习</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/算法/"><i class="fa "></i>算法</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>时间轴</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="notminist数据预处理示范LogisticRegression训练">
            
	            notminist数据预处理示范LogisticRegression训练
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/分类">
            分类
        </a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
                    <a href="/tags/深度学习" title='深度学习'>
                        深度学习
                    </a>
                
                    <a href="/tags/机器学习" title='机器学习'>
                        机器学习
                    </a>
                
                    <a href="/tags/sklearn" title='sklearn'>
                        sklearn
                    </a>
                
            
        </span>
    </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2018/01/06</span>
        </span>
    
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <p>[TOC]</p>
<h3 id="要点"><a href="#要点" class="headerlink" title="要点"></a>要点</h3><p>我们这里采用notMNIST数据集，重点是对数据进行预处理，涉及内容包括：</p>
<ol>
<li>图像展示</li>
<li>图像转化为训练数据</li>
<li>数据拆分成训练数据以及验证数据</li>
<li>检查数据的平衡性，shuffle后的数据是否可信</li>
<li>大量数据时如何快速检查重叠程度——矩阵操作</li>
<li>采用传统的机器学习训练一个简单的分类器</li>
<li>绘制学习曲线</li>
</ol>
<h4 id="notMNIST-入门"><a href="#notMNIST-入门" class="headerlink" title="notMNIST 入门"></a>notMNIST 入门</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 作业目的:用简单线性分类训练图像分类器</span></span><br><span class="line"><span class="comment"># 准备工作:下载数据集</span></span><br><span class="line"><span class="comment"># These are all the modules we'll be using later. Make sure you can import them</span></span><br><span class="line"><span class="comment"># before proceeding further.</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> display, Image</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"><span class="keyword">from</span> six.moves.urllib.request <span class="keyword">import</span> urlretrieve</span><br><span class="line"><span class="keyword">from</span> six.moves <span class="keyword">import</span> cPickle <span class="keyword">as</span> pickle</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据集采用的是notminist 数据集，这个更加像真实的数据集，不如mnist 数据集干净，更加有难度</span></span><br><span class="line"><span class="comment"># 数据集有训练集 500K ，测试集 19000，这个规模在PC机上跑很快</span></span><br><span class="line"><span class="comment"># 标签为A 到 J (10个类别)</span></span><br><span class="line"><span class="comment"># 每个图像特征 28*28 像素</span></span><br><span class="line"><span class="comment"># 原数据地址 http://yaroslavvb.blogspot.com/2011/09/notmnist-dataset.html</span></span><br><span class="line"><span class="comment"># 代码中的链接貌似下不了了</span></span><br><span class="line"><span class="string">""""""</span><span class="string">""""""</span><span class="string">"将数据下载到本地"</span><span class="string">""""""</span><span class="string">""""""</span><span class="string">""""""</span></span><br><span class="line">url = <span class="string">'https://commondatastorage.googleapis.com/books1000/'</span></span><br><span class="line">last_percent_reported = <span class="keyword">None</span></span><br><span class="line">data_root = <span class="string">'.'</span>  <span class="comment"># Change me to store data elsewhere</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个是用来汇报下载过程的，下载了多少</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_progress_hook</span><span class="params">(count, blockSize, totalSize)</span>:</span></span><br><span class="line">    <span class="string">"""A hook to report the progress of a download. This is mostly intended for users with</span></span><br><span class="line"><span class="string">    slow internet connections. Reports every 5% change in download progress.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">global</span> last_percent_reported</span><br><span class="line">    percent = int(count * blockSize * <span class="number">100</span> / totalSize)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> last_percent_reported != percent:</span><br><span class="line">        <span class="keyword">if</span> percent % <span class="number">5</span> == <span class="number">0</span>:</span><br><span class="line">            sys.stdout.write(<span class="string">"%s%%"</span> % percent)</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sys.stdout.write(<span class="string">"."</span>)</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">        last_percent_reported = percent</span><br><span class="line"></span><br><span class="line"><span class="comment">#这个是根据url 来下载文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">maybe_download</span><span class="params">(filename, expected_bytes, force=False)</span>:</span></span><br><span class="line">    <span class="string">"""Download a file if not present, and make sure it's the right size."""</span></span><br><span class="line">    dest_filename = os.path.join(data_root, filename)</span><br><span class="line">    <span class="keyword">if</span> force <span class="keyword">or</span> <span class="keyword">not</span> os.path.exists(dest_filename):</span><br><span class="line">        print(<span class="string">'Attempting to download:'</span>, filename)</span><br><span class="line">        filename, _ = urlretrieve(url + filename, dest_filename, reporthook=download_progress_hook)</span><br><span class="line">        print(<span class="string">'\nDownload Complete!'</span>)</span><br><span class="line">    statinfo = os.stat(dest_filename)</span><br><span class="line">    <span class="keyword">if</span> statinfo.st_size == expected_bytes:</span><br><span class="line">        print(<span class="string">'Found and verified'</span>, dest_filename)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(</span><br><span class="line">            <span class="string">'Failed to verify '</span> + dest_filename + <span class="string">'. Can you get to it with a browser?'</span>)</span><br><span class="line">    <span class="keyword">return</span> dest_filename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果需要下载启用下面代码</span></span><br><span class="line"><span class="comment"># train_filename = maybe_download('notMNIST_large.tar.gz', 247336696)</span></span><br><span class="line"><span class="comment"># test_filename = maybe_download('notMNIST_small.tar.gz', 8458043)</span></span><br><span class="line"><span class="string">""""""</span><span class="string">""""""</span><span class="string">""""""</span><span class="string">""""""</span><span class="string">"下载结束"</span><span class="string">""""""</span><span class="string">""""""</span><span class="string">""""""</span><span class="string">""""""</span><span class="string">""""""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;下载结束&apos;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">train_filename = <span class="string">'notMNIST_large.tar.gz'</span></span><br><span class="line">test_filename = <span class="string">"notMNIST_small.tar.gz"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">""""""</span><span class="string">""""""</span><span class="string">" 接下来解压这个文件，里面有目录，标记着A 到J"</span><span class="string">""""""</span><span class="string">""""""</span><span class="string">""</span></span><br><span class="line"><span class="comment"># 使用上面train_filename test_filename 来解压</span></span><br><span class="line"><span class="comment"># 解压非常的耗时间</span></span><br><span class="line"><span class="comment"># 解压后输出目录 train_folders  test_folders</span></span><br><span class="line">num_classes = <span class="number">10</span></span><br><span class="line">np.random.seed(<span class="number">133</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压tar.gz 文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">maybe_extract</span><span class="params">(filename, force=False)</span>:</span></span><br><span class="line">    root = os.path.splitext(os.path.splitext(filename)[<span class="number">0</span>])[<span class="number">0</span>]  <span class="comment"># remove .tar.gz</span></span><br><span class="line">    <span class="keyword">if</span> os.path.isdir(root) <span class="keyword">and</span> <span class="keyword">not</span> force:</span><br><span class="line">        <span class="comment"># You may override by setting force=True.</span></span><br><span class="line">        print(<span class="string">'%s already present - Skipping extraction of %s.'</span> % (root, filename))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'Extracting data for %s. This may take a while. Please wait.'</span> % root)</span><br><span class="line">        tar = tarfile.open(filename)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        tar.extractall(data_root)</span><br><span class="line">        tar.close()</span><br><span class="line">    data_folders = [</span><br><span class="line">        os.path.join(root, d) <span class="keyword">for</span> d <span class="keyword">in</span> sorted(os.listdir(root))</span><br><span class="line">        <span class="keyword">if</span> os.path.isdir(os.path.join(root, d))]</span><br><span class="line">    <span class="keyword">if</span> len(data_folders) != num_classes:</span><br><span class="line">        <span class="keyword">raise</span> Exception(</span><br><span class="line">            <span class="string">'Expected %d folders, one per class. Found %d instead.'</span> % (</span><br><span class="line">                num_classes, len(data_folders)))</span><br><span class="line">    print(data_folders)</span><br><span class="line">    <span class="keyword">return</span> data_folders</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># train_folders = maybe_extract(train_filename)</span></span><br><span class="line"><span class="comment"># test_folders = maybe_extract(test_filename)</span></span><br><span class="line"></span><br><span class="line"><span class="string">""" 这个解压部分就结束了 """</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos; 这个解压部分就结束了 &apos;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压结束后可以得到这个目录列表</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> List</span><br><span class="line"></span><br><span class="line">train_folders: List[str] = [<span class="string">'notMNIST_large/A'</span>, <span class="string">'notMNIST_large/B'</span>, <span class="string">'notMNIST_large/C'</span>, <span class="string">'notMNIST_large/D'</span>, <span class="string">'notMNIST_large/E'</span>, <span class="string">'notMNIST_large/F'</span>, <span class="string">'notMNIST_large/G'</span>, <span class="string">'notMNIST_large/H'</span>, <span class="string">'notMNIST_large/I'</span>, <span class="string">'notMNIST_large/J'</span>]</span><br><span class="line">test_folders  = [<span class="string">'notMNIST_small/A'</span>, <span class="string">'notMNIST_small/B'</span>, <span class="string">'notMNIST_small/C'</span>, <span class="string">'notMNIST_small/D'</span>, <span class="string">'notMNIST_small/E'</span>, <span class="string">'notMNIST_small/F'</span>, <span class="string">'notMNIST_small/G'</span>, <span class="string">'notMNIST_small/H'</span>, <span class="string">'notMNIST_small/I'</span>, <span class="string">'notMNIST_small/J'</span>]</span><br></pre></td></tr></table></figure>
<h4 id="问题-1-展示一些图像"><a href="#问题-1-展示一些图像" class="headerlink" title="问题 1: 展示一些图像"></a>问题 1: 展示一些图像</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""第一个作业  显示图像"""</span></span><br><span class="line"><span class="comment"># 可以使用 IPython.display.</span></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span>第一个作业 通过 IPython.display 展示图像</span></span><br><span class="line"><span class="comment"># display(Image("notMNIST_large/A/a2F6b28udHRm.png"))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从每个类中随机选取几张图片展示</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showimages</span><span class="params">(num_per_class:int,train_folders)</span>:</span></span><br><span class="line">    plot_images = []  <span class="comment"># 展示的图片</span></span><br><span class="line">    plt.figure()     <span class="comment"># 定义画图</span></span><br><span class="line">    index = <span class="number">1</span>       <span class="comment"># 定义小图的索引</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(num_per_class):</span><br><span class="line">        <span class="comment"># 拿到list 中的元素</span></span><br><span class="line">        <span class="keyword">for</span> folder <span class="keyword">in</span> train_folders:</span><br><span class="line">            <span class="comment"># 列出所有子文件夹和子文件</span></span><br><span class="line">            image_files = os.listdir(folder)</span><br><span class="line">            <span class="comment"># 分成num_per_class 行，len(train_folders)列</span></span><br><span class="line">            plt.subplot(num_per_class,len(train_folders),index)</span><br><span class="line">            img = plt.imread(os.path.join(folder, image_files[np.random.randint(len(image_files))]))</span><br><span class="line">            plt.imshow(img,cmap=<span class="string">'gray'</span>)</span><br><span class="line">            index = index +<span class="number">1</span></span><br><span class="line">            plt.axis(<span class="string">'off'</span>)</span><br><span class="line">    plt.show()         </span><br><span class="line"></span><br><span class="line">showimages(<span class="number">5</span>,train_folders)</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448522392output_5_0.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""第二种用pillow"""</span></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line">im = Image.open(<span class="string">"notMNIST_large/A/a2F6b28udHRm.png"</span>)</span><br><span class="line">im</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448524942output_6_0.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""第三种用MATLAB 的plt"""</span></span><br><span class="line">img = plt.imread(<span class="string">"notMNIST_large/A/a2F6b28udHRm.png"</span>)</span><br><span class="line">plt.imshow(img)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;matplotlib.image.AxesImage at 0x11e5e4a8&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448525027output_7_1.png" alt="png"></p>
<h4 id="图像数据转换成-3D-数组"><a href="#图像数据转换成-3D-数组" class="headerlink" title="图像数据转换成 3D 数组"></a>图像数据转换成 3D 数组</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""" 这里开始预处理数据集 """</span><span class="string">""</span></span><br><span class="line"><span class="comment"># 1. 分割数据：由于数据没有办法全部放入内存，将数据集按照每个类分别放到磁盘中</span></span><br><span class="line"><span class="comment"># 2. 组合训练数据：将每个类的数据再组合成计算机内存可放的集合</span></span><br><span class="line"><span class="comment"># 3. 把图片处理成3维矩阵：我们把整个数值转化成 float 3维数组 (image index, x, y) 具体代码如下：dataset[num_images, :, :] = image_data</span></span><br><span class="line"><span class="comment"># 4. 归一化：把数据处理成 均值为0 ，方差是 0.5 更好</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;&quot; 这里开始预处理数据集 &apos;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">image_size = <span class="number">28</span>  <span class="comment"># Pixel width and height.</span></span><br><span class="line">pixel_depth = <span class="number">255.0</span>  <span class="comment"># Number of levels per pixel.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 把每个标签的图像通过imageio.imread(image_file).astype(float)变成二维矩阵载入内存中</span></span><br><span class="line"><span class="comment"># 2. 进行归一化处理(x-128)/255  【0,255】 -&gt;[-128,128] -&gt;[-0.5,0.5]</span></span><br><span class="line"><span class="comment"># 3. 然后打包成[num_images, :, :]</span></span><br><span class="line"><span class="comment"># folder = A....C..F</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_letter</span><span class="params">(folder, min_num_images)</span>:</span></span><br><span class="line">    <span class="string">"""Load the data for a single letter label."""</span></span><br><span class="line">    image_files = os.listdir(folder)</span><br><span class="line">    dataset = np.ndarray(shape=(len(image_files), image_size, image_size),</span><br><span class="line">                         dtype=np.float32)</span><br><span class="line">    print(folder)</span><br><span class="line">    num_images = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> image_files:</span><br><span class="line">        image_file = os.path.join(folder, image)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 这部分就是进行归一化处理了 (x-128)/255  那么结果就在 【0,255】 -&gt;[-128,128] -&gt;[-0.5,0.5]</span></span><br><span class="line">            image_data = (imageio.imread(image_file).astype(float) -</span><br><span class="line">                          pixel_depth / <span class="number">2</span>) / pixel_depth</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 判断分辨率，大小不一致报错</span></span><br><span class="line">            <span class="keyword">if</span> image_data.shape != (image_size, image_size):</span><br><span class="line">                <span class="comment"># 触发异常后，后面的代码就不会再执行</span></span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">'Unexpected image shape: %s'</span> % str(image_data.shape))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 这个就是最关键的代码，把图像数据加入到dataset中</span></span><br><span class="line">            dataset[num_images, :, :] = image_data</span><br><span class="line">            num_images = num_images + <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> (IOError, ValueError) <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">'Could not read:'</span>, image_file, <span class="string">':'</span>, e, <span class="string">'- it\'s ok, skipping.'</span>)</span><br><span class="line"></span><br><span class="line">    dataset = dataset[<span class="number">0</span>:num_images, :, :]</span><br><span class="line">    <span class="comment"># 检查下是不是所有的图像都已经放好了</span></span><br><span class="line">    <span class="keyword">if</span> num_images &lt; min_num_images:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'Many fewer images than expected: %d &lt; %d'</span> %</span><br><span class="line">                        (num_images, min_num_images))</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'Full dataset tensor:'</span>, dataset.shape)</span><br><span class="line">    <span class="comment"># 计算均值</span></span><br><span class="line">    print(<span class="string">'Mean:'</span>, np.mean(dataset))</span><br><span class="line">    <span class="comment"># 计算标准差</span></span><br><span class="line">    print(<span class="string">'Standard deviation:'</span>, np.std(dataset))</span><br><span class="line">    <span class="keyword">return</span> dataset</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 持久化每个标签的数据集</span></span><br><span class="line"><span class="comment"># 重命名成" folder.pickle"</span></span><br><span class="line"><span class="comment"># 使用方法为 pickle.dump(dataset, f, pickle.HIGHEST_PROTOCOL)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">maybe_pickle</span><span class="params">(data_folders, min_num_images_per_class, force=False)</span>:</span></span><br><span class="line">    dataset_names = []</span><br><span class="line">    <span class="keyword">for</span> folder <span class="keyword">in</span> data_folders:</span><br><span class="line">        <span class="comment"># 把每个文件夹命名成A.pickle</span></span><br><span class="line">        set_filename = folder + <span class="string">'.pickle'</span></span><br><span class="line">        <span class="comment"># 把数据集名称加入dataset_names</span></span><br><span class="line">        dataset_names.append(set_filename)</span><br><span class="line">        <span class="comment"># 避免多次执行的重复操作</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(set_filename) <span class="keyword">and</span> <span class="keyword">not</span> force:</span><br><span class="line">            <span class="comment"># You may override by setting force=True.</span></span><br><span class="line">            print(<span class="string">'%s already present - Skipping pickling.'</span> % set_filename)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'Pickling %s.'</span> % set_filename)</span><br><span class="line">            dataset = load_letter(folder, min_num_images_per_class)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> open(set_filename, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="comment"># 保存数据集pickle.dump</span></span><br><span class="line">                    <span class="comment"># 将 obj 持久化保存到文件 tmp.txt 中</span></span><br><span class="line">                    <span class="comment"># pickle.dump(obj, open("tmp.txt", "w"))</span></span><br><span class="line">                    <span class="comment"># obj: 要持久化保存的对象；</span></span><br><span class="line">                    <span class="comment"># file: 一个拥有 write() 方法的对象，并且这个 write() 方法能接收一个字符串作为参数。这个对象可以是一个以写模式打开的文件对象或者一个</span></span><br><span class="line">                    <span class="comment"># StringIO 对象，或者其他自定义的满足条件的对象。</span></span><br><span class="line">                    <span class="comment"># protocol: 这是一个可选的参数，默认为 3  ，如果设置为 4 ,则要求python 版本是3以上</span></span><br><span class="line">                    <span class="comment"># 有压缩功能</span></span><br><span class="line">                    pickle.dump(dataset, f, pickle.HIGHEST_PROTOCOL)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                print(<span class="string">'Unable to save data to'</span>, set_filename, <span class="string">':'</span>, e)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataset_names</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 调用方法处理数据处理,放心不会重复执行</span></span><br><span class="line">train_datasets = maybe_pickle(train_folders, <span class="number">45000</span>)</span><br><span class="line">test_datasets = maybe_pickle(test_folders, <span class="number">1800</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">notMNIST_large/A.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_large/B.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_large/C.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_large/D.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_large/E.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_large/F.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_large/G.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_large/H.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_large/I.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_large/J.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_small/A.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_small/B.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_small/C.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_small/D.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_small/E.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_small/F.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_small/G.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_small/H.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_small/I.pickle already present - Skipping pickling.</span><br><span class="line">notMNIST_small/J.pickle already present - Skipping pickling.</span><br></pre></td></tr></table></figure>
<h4 id="问题-2-验证归一化的图像"><a href="#问题-2-验证归一化的图像" class="headerlink" title="问题 2: 验证归一化的图像"></a>问题 2: 验证归一化的图像</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">TODO:</span>第二个作业 通过展示归一化后的图像以及标签 提示：你可以使用matplotlib.pyplot来展示图像</span></span><br><span class="line"><span class="comment"># 如何把pickle 载入内存中</span></span><br><span class="line">pickle_file_path = <span class="string">"notMNIST_large/B.pickle"</span></span><br><span class="line">f = open(pickle_file_path, <span class="string">'rb'</span>)</span><br><span class="line">letter_set = pickle.load(f)</span><br><span class="line">index = np.random.randint(<span class="number">0</span>,<span class="number">45000</span>)</span><br><span class="line">plt.imshow(letter_set[index,:,:])</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;matplotlib.image.AxesImage at 0xf86ae10&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448525118output_13_1.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> pickle_file <span class="keyword">in</span> train_datasets:</span><br><span class="line">    print(pickle_file)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">notMNIST_large/A.pickle</span><br><span class="line">notMNIST_large/B.pickle</span><br><span class="line">notMNIST_large/C.pickle</span><br><span class="line">notMNIST_large/D.pickle</span><br><span class="line">notMNIST_large/E.pickle</span><br><span class="line">notMNIST_large/F.pickle</span><br><span class="line">notMNIST_large/G.pickle</span><br><span class="line">notMNIST_large/H.pickle</span><br><span class="line">notMNIST_large/I.pickle</span><br><span class="line">notMNIST_large/J.pickle</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多展示一些归一化后的pickle图像,</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">：num_per_class:int 每个类展示几个图像</span></span><br><span class="line"><span class="string">train_datasets  就是pickle 的名称的list</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showimages_pickle</span><span class="params">(num_per_class:int,train_datasets)</span>:</span></span><br><span class="line">    plot_images = []  <span class="comment"># 展示的图片</span></span><br><span class="line">    plt.figure()     <span class="comment"># 定义画图</span></span><br><span class="line">    index = <span class="number">1</span>       <span class="comment"># 定义小图的索引</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(num_per_class):</span><br><span class="line">        <span class="comment"># 拿到list 中的元素</span></span><br><span class="line">        <span class="keyword">for</span> pickle_file <span class="keyword">in</span> train_datasets:</span><br><span class="line">            <span class="comment"># 载入pickle 的文件</span></span><br><span class="line">            f = open(pickle_file, <span class="string">'rb'</span>)</span><br><span class="line">            image_data_per_class = pickle.load(f)</span><br><span class="line">            <span class="comment"># 分成num_per_class 行，len(train_folders)列</span></span><br><span class="line">            plt.subplot(num_per_class,len(train_datasets),index)</span><br><span class="line">            plt.imshow( image_data_per_class[np.random.randint(np.shape(image_data_per_class)[<span class="number">0</span>])],cmap=<span class="string">'gray'</span>)</span><br><span class="line">            index = index +<span class="number">1</span></span><br><span class="line">            plt.axis(<span class="string">'off'</span>)</span><br><span class="line">    plt.show()         </span><br><span class="line"></span><br><span class="line">showimages_pickle(<span class="number">5</span>,train_datasets)</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448525183output_15_0.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第二种 通过IPython.display展示</span></span><br><span class="line">index = np.random.randint(<span class="number">0</span>,<span class="number">45000</span>)</span><br><span class="line"><span class="comment"># 但是IPython.display，我不知道如何载入图像，不知道谁懂</span></span><br></pre></td></tr></table></figure>
<h4 id="问题-3-验证数据平衡"><a href="#问题-3-验证数据平衡" class="headerlink" title="问题 3: 验证数据平衡"></a>问题 3: 验证数据平衡</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">TODO:</span>第三个作业 检查各个类之间的数据是否平衡</span></span><br><span class="line"><span class="comment"># 我认为平衡就是每个类的数据量是否一致</span></span><br><span class="line"><span class="comment"># 可能理解错误了？</span></span><br><span class="line"><span class="comment"># 把所有的数据集依次读出来，然后建立用柱状图表示出来</span></span><br><span class="line">labels = []</span><br><span class="line">num_of_labels = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># enumerate 枚举 可返回两个参数，一个是索引，一个是文件</span></span><br><span class="line"><span class="keyword">for</span> label, pickle_file <span class="keyword">in</span> enumerate(train_datasets):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> open(pickle_file, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            letter_set = pickle.load(f)</span><br><span class="line">            num = np.shape(letter_set)[<span class="number">0</span>]</span><br><span class="line">            num_of_labels.append(num)</span><br><span class="line">            labels.append(label)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">'Unable to process data from'</span>, pickle_file, <span class="string">':'</span>, e)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plt.bar(range(len(num_of_labels)), num_of_labels,color=<span class="string">'rgb'</span>,tick_label=labels)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;BarContainer object of 10 artists&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448525281output_17_1.png" alt="png"></p>
<h4 id="拆分数据集成批"><a href="#拆分数据集成批" class="headerlink" title="拆分数据集成批"></a>拆分数据集成批</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 由于计算的的配置没有办法装下所有的配置，所以只能部分拿出来，组合成自己想要的数据集大小，并且要根据需要调整数据集的大小</span></span><br><span class="line"><span class="comment"># 初始化变量 dataset (3维数组)，labels(1维数组)用于存放数据，</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_arrays</span><span class="params">(nb_rows, img_size)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> nb_rows:</span><br><span class="line">        <span class="comment"># ndarray 创建3维数组</span></span><br><span class="line">        dataset = np.ndarray((nb_rows, img_size, img_size), dtype=np.float32)</span><br><span class="line">        labels = np.ndarray(nb_rows, dtype=np.int32)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dataset, labels = <span class="keyword">None</span>, <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">return</span> dataset, labels</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一个参数用于 A.pickle B.pickle</span></span><br><span class="line"><span class="comment"># 第二个参数用于 设置训练集的大小</span></span><br><span class="line"><span class="comment"># 比如总共选择 train_size = 200000 条数据，那么就是每个类 选择 （200000/ 10类）条数据，组合集合</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge_datasets</span><span class="params">(pickle_files, train_size, valid_size=<span class="number">0</span>)</span>:</span></span><br><span class="line">    num_classes = len(pickle_files)</span><br><span class="line">    <span class="comment"># 如果valid_size = 0，那么就是生成valid_dataset =None</span></span><br><span class="line">    valid_dataset, valid_labels = make_arrays(valid_size, image_size)</span><br><span class="line">    train_dataset, train_labels = make_arrays(train_size, image_size)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试集的大小 ，注意除法是 //</span></span><br><span class="line">    <span class="comment"># 验证集的大小</span></span><br><span class="line">    vsize_per_class = valid_size // num_classes</span><br><span class="line">    tsize_per_class = train_size // num_classes</span><br><span class="line"></span><br><span class="line">    start_v, start_t = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    end_v, end_t = vsize_per_class, tsize_per_class</span><br><span class="line">    end_l = vsize_per_class + tsize_per_class</span><br><span class="line">    <span class="comment"># enumerate 枚举 可返回两个参数，一个是索引，一个是文件</span></span><br><span class="line">    <span class="keyword">for</span> label, pickle_file <span class="keyword">in</span> enumerate(pickle_files):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> open(pickle_file, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                letter_set = pickle.load(f)</span><br><span class="line">                <span class="comment"># let's shuffle the letters to have random validation and training set</span></span><br><span class="line">                <span class="comment"># 随机洗牌</span></span><br><span class="line">                np.random.shuffle(letter_set)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 把数据分成两部分，第一部分给 验证集valid 第二部分 测试集 train，每个都选一部分，组成最终数据集</span></span><br><span class="line">                <span class="keyword">if</span> valid_dataset <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                    valid_letter = letter_set[:vsize_per_class, :, :]</span><br><span class="line">                    valid_dataset[start_v:end_v, :, :] = valid_letter</span><br><span class="line">                    valid_labels[start_v:end_v] = label</span><br><span class="line">                    start_v += vsize_per_class</span><br><span class="line">                    end_v += vsize_per_class</span><br><span class="line"></span><br><span class="line">                train_letter = letter_set[vsize_per_class:end_l, :, :]</span><br><span class="line">                train_dataset[start_t:end_t, :, :] = train_letter</span><br><span class="line">                train_labels[start_t:end_t] = label</span><br><span class="line">                start_t += tsize_per_class</span><br><span class="line">                end_t += tsize_per_class</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">'Unable to process data from'</span>, pickle_file, <span class="string">':'</span>, e)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> valid_dataset, valid_labels, train_dataset, train_labels</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Optional</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> numpy.core.multiarray <span class="keyword">import</span> ndarray</span><br><span class="line"></span><br><span class="line">train_size = <span class="number">20000</span></span><br><span class="line">valid_size = <span class="number">1000</span></span><br><span class="line">test_size = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">valid_dataset, valid_labels, train_dataset, train_labels = merge_datasets(</span><br><span class="line">    train_datasets, train_size, valid_size)</span><br><span class="line">_, _, test_dataset, test_labels = merge_datasets(test_datasets, test_size)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Training:'</span>, train_dataset.shape, train_labels.shape)</span><br><span class="line">print(<span class="string">'Validation:'</span>, valid_dataset.shape, valid_labels.shape)</span><br><span class="line">print(<span class="string">'Testing:'</span>, test_dataset.shape, test_labels.shape)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面就是对做好的数据集进行洗牌</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">randomize</span><span class="params">(dataset, labels)</span>:</span></span><br><span class="line">  <span class="comment"># 获取label的排列</span></span><br><span class="line">  permutation = np.random.permutation(labels.shape[<span class="number">0</span>])</span><br><span class="line">  <span class="comment"># 用这个排列数来排序dataset 以及 label</span></span><br><span class="line">  shuffled_dataset = dataset[permutation,:,:]</span><br><span class="line">  shuffled_labels = labels[permutation]</span><br><span class="line">  <span class="keyword">return</span> shuffled_dataset, shuffled_labels</span><br><span class="line">train_dataset, train_labels = randomize(train_dataset, train_labels)</span><br><span class="line">test_dataset, test_labels = randomize(test_dataset, test_labels)</span><br><span class="line">valid_dataset, valid_labels = randomize(valid_dataset, valid_labels)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Training: (20000, 28, 28) (20000,)</span><br><span class="line">Validation: (1000, 28, 28) (1000,)</span><br><span class="line">Testing: (1000, 28, 28) (1000,)</span><br></pre></td></tr></table></figure>
<h4 id="问题-4-样本乱序与验证"><a href="#问题-4-样本乱序与验证" class="headerlink" title="问题 4: 样本乱序与验证"></a>问题 4: 样本乱序与验证</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Problem 4</span></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span>第四个作业 说服自己洗牌后的数据很好</span></span><br><span class="line"><span class="comment"># 接下来验证下数据平衡性，然后柱状图展示</span></span><br><span class="line"><span class="comment"># 思路获取标签中的每一类的个数，然后画出柱状图</span></span><br><span class="line"><span class="comment"># a = np.where(valid_labels==3) 过滤</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showbalance</span><span class="params">(labels)</span>:</span></span><br><span class="line">    num_of_labels = []</span><br><span class="line">    <span class="keyword">for</span> label <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        <span class="comment"># 这里我有个疑问，为什么label_per_class.shape 不能用？？？！！！</span></span><br><span class="line">        label_per_class = np.where(labels==label)</span><br><span class="line">        num_of_labels.append(np.shape(label_per_class)[<span class="number">1</span>])</span><br><span class="line">    </span><br><span class="line">    plt.bar(range(len(num_of_labels)), num_of_labels,color=<span class="string">'rgbcy'</span>,tick_label=range(len(num_of_labels)))</span><br><span class="line">    <span class="keyword">return</span> num_of_labels</span><br><span class="line"></span><br><span class="line">showbalance(valid_labels)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[100, 100, 100, 100, 100, 100, 100, 100, 100, 100]</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448525347output_21_1.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">TODO:</span>第四个作业 数据是否已经随机打乱，打乱后的标签是否正确</span></span><br><span class="line"><span class="comment"># 思路随机选择num_start个起始点，然后连续选择num_pic张图片和标签然后展示</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_pic_and_label</span><span class="params">(dataset,labels,num_start,num_pic)</span>:</span></span><br><span class="line">    plt.figure()</span><br><span class="line">    index = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_start):</span><br><span class="line">        start = np.random.randint(len(labels)-num_pic)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(num_pic):</span><br><span class="line">            plt.subplot(num_start,num_pic,index)</span><br><span class="line">            plt.imshow(dataset[start+j,:,:],cmap=<span class="string">'gray'</span>)</span><br><span class="line">            plt.title(labels[start+j])</span><br><span class="line">            index = index +<span class="number">1</span></span><br><span class="line">            plt.axis(<span class="string">'off'</span>)</span><br><span class="line">    plt.show()         </span><br><span class="line"></span><br><span class="line">show_pic_and_label(train_dataset, train_labels,<span class="number">5</span>,<span class="number">20</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448525439output_22_0.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把数据存储起来准备使用</span></span><br><span class="line"><span class="comment"># 合成路径 os.path.join</span></span><br><span class="line"><span class="comment"># 1.open(pickle_file, 'wb')</span></span><br><span class="line"><span class="comment"># 2.把数据集组合成键值对</span></span><br><span class="line"><span class="comment"># 3.pickle.dump(save, f, pickle.HIGHEST_PROTOCOL) 存放数据</span></span><br><span class="line">pickle_file = os.path.join(data_root, <span class="string">'notMNIST.pickle'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  f = open(pickle_file, <span class="string">'wb'</span>)</span><br><span class="line">  save = &#123;</span><br><span class="line">    <span class="string">'train_dataset'</span>: train_dataset,</span><br><span class="line">    <span class="string">'train_labels'</span>: train_labels,</span><br><span class="line">    <span class="string">'valid_dataset'</span>: valid_dataset,</span><br><span class="line">    <span class="string">'valid_labels'</span>: valid_labels,</span><br><span class="line">    <span class="string">'test_dataset'</span>: test_dataset,</span><br><span class="line">    <span class="string">'test_labels'</span>: test_labels,</span><br><span class="line">    &#125;</span><br><span class="line">  pickle.dump(save, f, pickle.HIGHEST_PROTOCOL)</span><br><span class="line">  f.close()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">  print(<span class="string">'Unable to save data to'</span>, pickle_file, <span class="string">':'</span>, e)</span><br><span class="line">  <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 操作系统获取文件声明，可以拿到文件大小</span></span><br><span class="line">statinfo = os.stat(pickle_file)</span><br><span class="line">print(<span class="string">'Compressed pickle size:'</span>, statinfo.st_size)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Compressed pickle size: 69080502</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line">localtime = time.asctime( time.localtime(time.time()) )</span><br><span class="line">print( time.asctime( time.localtime(time.time()) ))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tue Aug 28 15:21:49 2018</span><br></pre></td></tr></table></figure>
<h4 id="问题-5-寻找重叠样本"><a href="#问题-5-寻找重叠样本" class="headerlink" title="问题 5: 寻找重叠样本"></a>问题 5: 寻找重叠样本</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">TODO:</span>作业五 测量训练数据 与 交叉验证数据 间的重合程度</span></span><br><span class="line"><span class="comment"># 重合度高容易导致过拟合问题</span></span><br><span class="line"><span class="comment"># 计算向量间的欧式距离，判断图像是否相似，</span></span><br><span class="line"><span class="comment"># dist = numpy.sqrt(numpy.sum(numpy.square(vec1 - vec2)))</span></span><br><span class="line"><span class="comment"># dist = numpy.linalg.norm(vec1 - vec2)</span></span><br><span class="line"><span class="comment"># 余弦相似性 cosine_sim = np.inner(X, Y) / np.inner(np.abs(X), np.abs(Y))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">overlap</span><span class="params">(train_dataset,valid_dataset,threshold=<span class="number">0</span>,num_duplicate_to_show = <span class="number">5</span>)</span>:</span></span><br><span class="line">    print(<span class="string">"开始---&gt;"</span>,)</span><br><span class="line">    num_overlap = <span class="number">0</span>     <span class="comment">#   覆盖个数</span></span><br><span class="line">    print_pic_num = <span class="number">0</span>;  <span class="comment">#   打印图片个数</span></span><br><span class="line">    index = <span class="number">1</span>;</span><br><span class="line">    plt.figure()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(train_dataset.shape[<span class="number">0</span>]):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(valid_dataset.shape[<span class="number">0</span>]):</span><br><span class="line">            dist = np.linalg.norm(train_dataset[i,:,:]-valid_dataset[j,:,:])</span><br><span class="line">            <span class="keyword">if</span> dist &lt;= threshold:</span><br><span class="line">                num_overlap = num_overlap + <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(print_pic_num&lt;=num_duplicate_to_show):</span><br><span class="line">                    <span class="comment"># 画train_dataset第一个图</span></span><br><span class="line">                    plt.subplot(num_duplicate_to_show,<span class="number">2</span>,index)</span><br><span class="line">                    plt.title(<span class="string">"train_dataset"</span>)</span><br><span class="line">                    plt.imshow(train_dataset[i,:,:],cmap=<span class="string">'gray'</span>)</span><br><span class="line">                    index = index +<span class="number">1</span></span><br><span class="line">                    <span class="comment"># 画valid_dataset的一样图</span></span><br><span class="line">                    plt.subplot(num_duplicate_to_show,<span class="number">2</span>,index)</span><br><span class="line">                    plt.title(<span class="string">"valid_dataset"</span>)</span><br><span class="line">                    plt.imshow(valid_dataset[j,:,:],cmap=<span class="string">'gray'</span>)</span><br><span class="line">                    print_pic_num = print_pic_num + <span class="number">1</span></span><br><span class="line">                    index = index +<span class="number">1</span></span><br><span class="line">    print(<span class="string">"重合数据个数是："</span>,num_overlap)</span><br><span class="line">    print(<span class="string">"train_dataset重合率是："</span>,num_overlap/train_dataset.shape[<span class="number">0</span>])</span><br><span class="line">    print(<span class="string">"valid_dataset重合率是："</span>,num_overlap/valid_dataset.shape[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">return</span> num_overlap</span><br><span class="line"></span><br><span class="line">overlap(train_dataset,valid_dataset,threshold=<span class="number">0</span>,num_duplicate_to_show = <span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">开始---&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\AppData\Local\Programs\Python\Python36\lib\site-packages\matplotlib\cbook\deprecation.py:107: MatplotlibDeprecationWarning: Adding an axes using the same arguments as a previous axes currently reuses the earlier instance.  In a future version, a new instance will always be created and returned.  Meanwhile, this warning can be suppressed, and the future behavior ensured, by passing a unique label to each axes instance.</span><br><span class="line">  warnings.warn(message, mplDeprecation, stacklevel=1)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">重合数据个数是： 213540</span><br><span class="line">train_dataset重合率是： 1.0677</span><br><span class="line">valid_dataset重合率是： 21.354</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">213540</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448525542output_25_4.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">overlap_cos_matrix</span><span class="params">(source_dataset,target_dataset,threshold=<span class="number">1</span>,num_duplicate_to_show = <span class="number">5</span>,selfcheck = False)</span>:</span></span><br><span class="line">    print(<span class="string">"开始时间："</span>,time.asctime( time.localtime(time.time()) ))</span><br><span class="line">    X = np.reshape(source_dataset,(source_dataset.shape[<span class="number">0</span>],<span class="number">-1</span>))</span><br><span class="line">    Y = np.reshape(target_dataset,(target_dataset.shape[<span class="number">0</span>],<span class="number">-1</span>))</span><br><span class="line">    <span class="keyword">assert</span> (X.shape[<span class="number">1</span>] == Y.shape[<span class="number">1</span>])</span><br><span class="line">    <span class="comment"># 计算余弦相似度，注意这里是矩阵相乘 </span></span><br><span class="line">    cosine_sim = np.dot(X, Y.T) / np.inner(np.abs(X), np.abs(Y))</span><br><span class="line">    <span class="keyword">assert</span> (cosine_sim.shape == (X.shape[<span class="number">0</span>],Y.shape[<span class="number">0</span>]))</span><br><span class="line">    print(cosine_sim.shape)</span><br><span class="line">    <span class="comment"># 判断cosine_sim中的元素是否有等于threshold的，如果有就是相等</span></span><br><span class="line">    num_source = <span class="number">0</span></span><br><span class="line">    num_target = <span class="number">0</span></span><br><span class="line">    print_pic_num = <span class="number">1</span>;</span><br><span class="line">    plt.figure()</span><br><span class="line">    print(<span class="string">"矩阵计算结束："</span>,time.asctime( time.localtime(time.time()) ))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(X.shape[<span class="number">0</span>]):</span><br><span class="line">        <span class="comment"># 第i 行中所有重复的图片索引</span></span><br><span class="line">        dup_indices = np.where(cosine_sim[i,:] &gt;= threshold)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> dup_indices[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">if</span> i==j <span class="keyword">and</span> selfcheck:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                num_source = num_source +<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(print_pic_num&lt;=num_duplicate_to_show):</span><br><span class="line">                    <span class="comment"># 画train_dataset第一个图</span></span><br><span class="line">                    plt.subplot(num_duplicate_to_show,<span class="number">2</span>,print_pic_num)</span><br><span class="line">                    plt.imshow(source_dataset[i,:,:],cmap=<span class="string">'gray'</span>)</span><br><span class="line">                    print_pic_num = print_pic_num +<span class="number">1</span></span><br><span class="line">                    <span class="comment"># 画valid_dataset的一样图</span></span><br><span class="line">                    plt.subplot(num_duplicate_to_show,<span class="number">2</span>,print_pic_num)</span><br><span class="line">                    plt.imshow(target_dataset[j,:,:],cmap=<span class="string">'gray'</span>)</span><br><span class="line">                    print_pic_num = print_pic_num + <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">"结束时间："</span>,time.asctime( time.localtime(time.time()) ))</span><br><span class="line">    print(<span class="string">"重合数据个数是："</span>,num_source)</span><br><span class="line">    print(<span class="string">"train_dataset重合率是："</span>,num_source/source_dataset.shape[<span class="number">0</span>])</span><br><span class="line">    <span class="comment"># print("valid_dataset重合率是：",num_overlap/valid_dataset.shape[0])</span></span><br><span class="line">    plt.axis(<span class="string">'off'</span>)</span><br><span class="line">    plt.show()</span><br><span class="line">    <span class="keyword">return</span> num_source</span><br><span class="line">        </span><br><span class="line">overlap_cos_matrix(valid_dataset,train_dataset,threshold=<span class="number">1</span>,num_duplicate_to_show = <span class="number">10</span>,selfcheck = <span class="keyword">False</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">开始时间： Tue Aug 28 15:55:19 2018</span><br><span class="line">(1000, 20000)</span><br><span class="line">矩阵计算结束： Tue Aug 28 15:55:20 2018</span><br><span class="line">结束时间： Tue Aug 28 15:55:20 2018</span><br><span class="line">重合数据个数是： 47</span><br><span class="line">train_dataset重合率是： 0.047</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448525630output_26_1.png" alt="png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">47</span><br></pre></td></tr></table></figure>
<h4 id="问题-6-训练一个简单的机器学习模型"><a href="#问题-6-训练一个简单的机器学习模型" class="headerlink" title="问题 6: 训练一个简单的机器学习模型"></a>问题 6: 训练一个简单的机器学习模型</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">TODO:</span>作业六 验证集自己内部的重复图片有多少？</span></span><br><span class="line">res = overlap_cos_matrix(valid_dataset,valid_dataset,threshold=<span class="number">1</span>,num_duplicate_to_show = <span class="number">10</span>,selfcheck = <span class="keyword">True</span>)</span><br><span class="line"><span class="comment"># 每个图像都和自己重叠</span></span><br><span class="line">res = res - valid_dataset.shape[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">开始时间： Tue Aug 28 15:55:23 2018</span><br><span class="line">(1000, 1000)</span><br><span class="line">矩阵计算结束： Tue Aug 28 15:55:23 2018</span><br><span class="line">结束时间： Tue Aug 28 15:55:23 2018</span><br><span class="line">重合数据个数是： 16</span><br><span class="line">train_dataset重合率是： 0.016</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448525746output_27_1.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扩展一下如何判断两个图是否相似呢，可以通过下面的代码——直方图相似度</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">difference</span><span class="params">(hist1,hist2)</span>:</span></span><br><span class="line">    sum1 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(hist1)):</span><br><span class="line">       <span class="keyword">if</span> (hist1[i] == hist2[i]):</span><br><span class="line">          sum1 += <span class="number">1</span></span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           sum1 += <span class="number">1</span> - float(abs(hist1[i] - hist2[i]))/ max(hist1[i], hist2[i])</span><br><span class="line">    <span class="keyword">return</span> sum1/len(hist1)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">similary_calculate</span><span class="params">(img1, img2)</span>:</span></span><br><span class="line">        img1_reshape = np.reshape(img1, (<span class="number">28</span> * <span class="number">28</span>, <span class="number">1</span>))</span><br><span class="line">        img1_reshape = np.reshape(img2, (<span class="number">28</span> * <span class="number">28</span>, <span class="number">1</span>))</span><br><span class="line">        hist1 = list(img1_reshape.getdata())</span><br><span class="line">        hist2 = list(img1_reshape.getdata())</span><br><span class="line">        <span class="keyword">return</span> difference(hist1, hist2)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">TODO:</span>作业七 创建一个消过毒的测试以及验证集 比较你们在后续作业的准确性</span></span><br><span class="line"><span class="comment"># 思路一: 在目前基础上做 </span></span><br><span class="line"><span class="comment"># 1. 首先trainset的pickle检查重复的，如果重复的删除</span></span><br><span class="line"><span class="comment"># 2. validateset的pickle检查重复的，如果重复的删除</span></span><br><span class="line"><span class="comment"># 3. test的pickle 检查重复的，重复的删除</span></span><br><span class="line"><span class="comment"># 4. train 和 valid 中重复的，把valid 删除</span></span><br><span class="line"><span class="comment"># 5. train 和test 中重复的，把test 删除</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 思路二：从头做</span></span><br><span class="line"><span class="comment"># 1. 把图像数据按类查找重复的，每个图像和其他所有图像匹配，重复就删除</span></span><br><span class="line"><span class="comment"># 2. 重新执行 转换3D数据，归一化，拆分成组合成新批次</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">TODO:</span>作业八 using 50, 100, 1000 and 5000 training samples，用sklearn 训练一个模型</span></span><br><span class="line"><span class="comment"># 提示使用sklearn 的  linear_model.LogisticRegression()</span></span><br><span class="line"><span class="comment"># 思路一：直接用学习曲线，不用上面分好的验证集</span></span><br><span class="line"><span class="comment"># from sklearn.model_selection import learning_curve #学习曲线模块</span></span><br><span class="line"><span class="comment"># from sklearn.linear_model import LogisticRegression</span></span><br><span class="line"><span class="comment"># from sklearn.model_selection import ShuffleSplit # 专业的数据集分割包</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># X = train_dataset.reshape(train_dataset.shape[0],-1)</span></span><br><span class="line"><span class="comment"># y = train_labels</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># train_sizes, train_scores, test_scores= learning_curve(</span></span><br><span class="line"><span class="comment">#     model, X, y,cv=5  train_sizes=[50,100,1000,5000],n_jobs=5)</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># train_scores</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 思路二：自己做预测，自己做学习曲线，用上面分好的验证集</span></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> learning_curve <span class="comment">#学习曲线模块</span></span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> ShuffleSplit <span class="comment"># 专业的数据集分割包</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># train_dataset, train_labels = randomize(train_dataset, train_labels)</span></span><br><span class="line"><span class="comment"># test_dataset, test_labels = randomize(test_dataset, test_labels)</span></span><br><span class="line"><span class="comment"># valid_dataset, valid_labels = randomize(valid_dataset, valid_labels)</span></span><br><span class="line"></span><br><span class="line">train_size=[<span class="number">50</span>,<span class="number">100</span>,<span class="number">1000</span>,<span class="number">5000</span>,<span class="number">8000</span>,<span class="number">15000</span>,<span class="number">20000</span>]</span><br><span class="line">train_scores = []</span><br><span class="line">valid_scores = []</span><br><span class="line">test_scores  = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> size <span class="keyword">in</span> train_size:</span><br><span class="line">    <span class="comment"># 每次循环都要新建模型，solver适合数据较多的情况，比较快</span></span><br><span class="line">    model = LogisticRegression(solver= <span class="string">'saga'</span>,multi_class=<span class="string">'multinomial'</span>)</span><br><span class="line">    <span class="comment"># 由于train_dataset中数据已经打乱了，所以按顺序拿</span></span><br><span class="line">    X = train_dataset[<span class="number">0</span>:size,:].reshape(size,<span class="number">-1</span>)</span><br><span class="line">    y = train_labels[<span class="number">0</span>:size]</span><br><span class="line">    X_valid = valid_dataset.reshape(valid_dataset.shape[<span class="number">0</span>],<span class="number">-1</span>)</span><br><span class="line">    y_valid = valid_labels</span><br><span class="line">    X_test = test_dataset.reshape(test_dataset.shape[<span class="number">0</span>],<span class="number">-1</span>)</span><br><span class="line">    y_test = test_labels</span><br><span class="line">    </span><br><span class="line">    model.fit(X,y)</span><br><span class="line">    train_scores.append(model.score(X,y))</span><br><span class="line">    valid_scores.append(model.score(X_valid,y_valid))</span><br><span class="line">    test_scores.append(model.score(X_test,y_test))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\AppData\Local\Programs\Python\Python36\lib\site-packages\sklearn\linear_model\sag.py:326: ConvergenceWarning: The max_iter was reached which means the coef_ did not converge</span><br><span class="line">  &quot;the coef_ did not converge&quot;, ConvergenceWarning)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># axis=1 对行进行操作，由于上面的cv=分成了20份，所以 train_scores 是一个20个元素的数组</span></span><br><span class="line"><span class="comment"># train_scores_mean = np.mean(train_scores, axis=1)</span></span><br><span class="line"><span class="comment"># valid_scores_mean = np.mean(valid_scores, axis=1)</span></span><br><span class="line"><span class="comment"># test_scores_mean =  np.mean(test_scores, axis=1)</span></span><br><span class="line"><span class="comment"># train_sizes 横坐标，train_loss_mean 纵坐标，形状‘o-’,红色</span></span><br><span class="line">plt.plot(train_size, train_scores, <span class="string">'o-'</span>, color=<span class="string">"r"</span>,</span><br><span class="line">         label=<span class="string">"Training"</span>)</span><br><span class="line">plt.plot(train_size, valid_scores, <span class="string">'o-'</span>, color=<span class="string">"b"</span>,</span><br><span class="line">        label=<span class="string">"Cross-validation"</span>)</span><br><span class="line">plt.plot(train_size, test_scores, <span class="string">'o-'</span>, color=<span class="string">"g"</span>,</span><br><span class="line">        label=<span class="string">"test"</span>)</span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">"Training examples"</span>)</span><br><span class="line">plt.ylabel(<span class="string">"Loss"</span>)</span><br><span class="line"><span class="comment"># 将图标签——图例放到最佳的位置</span></span><br><span class="line">plt.legend(loc=<span class="string">"best"</span>)</span><br><span class="line">title = <span class="string">"Learning Curves"</span></span><br><span class="line">plt.title(title)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Text(0.5,1,&apos;Learning Curves&apos;)</span><br></pre></td></tr></table></figure>
<p><img src="https://sudl-blog-oss.oss-cn-hangzhou.aliyuncs.com/1535448525816output_32_1.png" alt="png"></p>

    </div>

    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">sudl</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2018/02/01/test_01_花瓣_通用模型/" class="pre-post btn btn-default" title='sklearn的鸢尾花瓣数据集02'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">sklearn的鸢尾花瓣数据集02</span>
        </a>
    
    
        <a href="/2017/08/21/搭建免费博客HEXO+GitHub/" class="next-post btn btn-default" title='搭建免费博客HEXO+GitHub'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">搭建免费博客HEXO+GitHub</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
<div id="lv-container" data-id="city" data-uid="MTAyMC8zMzA1MS85NjEz">
  <script type="text/javascript">
     (function(d, s) {
         var j, e = d.getElementsByTagName(s)[0];
         if (typeof LivereTower === 'function') { return; }
         j = d.createElement(s);
         j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
         j.async = true;
         e.parentNode.insertBefore(j, e);
     })(document, 'script');
  </script>
</div>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#要点"><span class="toc-text">要点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#notMNIST-入门"><span class="toc-text">notMNIST 入门</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#问题-1-展示一些图像"><span class="toc-text">问题 1: 展示一些图像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#图像数据转换成-3D-数组"><span class="toc-text">图像数据转换成 3D 数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#问题-2-验证归一化的图像"><span class="toc-text">问题 2: 验证归一化的图像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#问题-3-验证数据平衡"><span class="toc-text">问题 3: 验证数据平衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拆分数据集成批"><span class="toc-text">拆分数据集成批</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#问题-4-样本乱序与验证"><span class="toc-text">问题 4: 样本乱序与验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#问题-5-寻找重叠样本"><span class="toc-text">问题 5: 寻找重叠样本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#问题-6-训练一个简单的机器学习模型"><span class="toc-text">问题 6: 训练一个简单的机器学习模型</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12"> 
                <span>Copyright &copy; 2017
                </span> | 
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> | 
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script src="/js/app.js?rev=@@hash"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</body>
</html>